<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Rocket Telemetry Dashboard</title>
  <!-- Load Chart.js from a CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      padding: 1rem;
    }
    .chart-row {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .chart-container {
      width: 49%;
      border: 1px solid #ccc;
      padding: 8px;
      box-sizing: border-box;
    }
    /* Full width for GPS chart */
    #gps-container {
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Rocket Telemetry Dashboard</h1>

  <!-- First row: Altitude & Temperature -->
  <div class="chart-row">
    <div class="chart-container">
      <canvas id="altitudeChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="temperatureChart"></canvas>
    </div>
  </div>

  <!-- Second row: Acceleration & Descent Rate -->
  <div class="chart-row">
    <div class="chart-container">
      <canvas id="accelChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="descentChart"></canvas>
    </div>
  </div>

  <!-- Third row: GPS (full width) -->
  <div class="chart-container" id="gps-container">
    <canvas id="gpsChart"></canvas>
  </div>

  <script>
    // Create the Chart.js contexts
    const altitudeCtx = document.getElementById('altitudeChart').getContext('2d');
    const temperatureCtx = document.getElementById('temperatureChart').getContext('2d');
    const accelCtx = document.getElementById('accelChart').getContext('2d');
    const descentCtx = document.getElementById('descentChart').getContext('2d');
    const gpsCtx = document.getElementById('gpsChart').getContext('2d');

    // --- Chart Instances ---
    let altitudeChart = new Chart(altitudeCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Altitude (ft)',
          data: [],
          borderColor: 'blue',
          fill: false
        }]
      },
      options: {
        scales: {
          x: {
            title: { display: true, text: 'Time (s)' }
          },
          y: {
            title: { display: true, text: 'Altitude (ft)' },
            // Always start at 0, default to 1400, but scale if data exceeds 1400
            min: 0,
            suggestedMax: 1400
          }
        }
      }
    });

    let temperatureChart = new Chart(temperatureCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Temperature (°F)',
          data: [],
          borderColor: 'red',
          fill: false
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Time (s)' } },
          y: { title: { display: true, text: 'Temperature (°F)' } }
        }
      }
    });

    let accelChart = new Chart(accelCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Acceleration (ft/s^2)',
          data: [],
          borderColor: 'green',
          fill: false
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Time (s)' } },
          y: { title: { display: true, text: 'Acceleration (ft/s^2)' } }
        }
      }
    });

    let descentChart = new Chart(descentCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Descent Rate (ft/s)',
          data: [],
          borderColor: 'orange',
          fill: false
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Time (s)' } },
          y: { title: { display: true, text: 'Descent Rate (ft/s)' } }
        }
      }
    });

    let gpsChart = new Chart(gpsCtx, {
      type: 'scatter',
      data: {
        datasets: [{
          label: 'GPS Path',
          data: [],
          showLine: true,
          borderColor: 'grey',
          pointBackgroundColor: [],
          pointRadius: 4
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Longitude' } },
          y: { title: { display: true, text: 'Latitude' } }
        }
      }
    });

    // --- Time Handling: Relative to first data timestamp ---
    let launchTime = null;
    function relativeTime(absoluteT) {
      if (launchTime === null) {
        // Initialize 'launchTime' to the first data's timestamp
        launchTime = absoluteT;
      }
      let dt = absoluteT - launchTime;
      return +dt.toFixed(2); // 2 significant figures
    }

    // --- Fetch Data from Flask and Update Charts ---
    async function fetchDataAndUpdateCharts() {
      try {
        const response = await fetch('/data');
        const telemetry = await response.json();

        // Clear old data
        altitudeChart.data.labels = [];
        altitudeChart.data.datasets[0].data = [];

        temperatureChart.data.labels = [];
        temperatureChart.data.datasets[0].data = [];

        accelChart.data.labels = [];
        accelChart.data.datasets[0].data = [];

        descentChart.data.labels = [];
        descentChart.data.datasets[0].data = [];

        gpsChart.data.datasets[0].data = [];
        gpsChart.data.datasets[0].pointBackgroundColor = [];

        // Rebuild
        for (let i = 0; i < telemetry.length; i++) {
          const entry = telemetry[i];
          const timeSec = relativeTime(entry.timestamp);

          // Altitude
          if (entry.altitude !== null) {
            altitudeChart.data.labels.push(timeSec);
            altitudeChart.data.datasets[0].data.push(entry.altitude.toFixed(2));
          }

          // Temperature
          if (entry.temperature !== null) {
            temperatureChart.data.labels.push(timeSec);
            temperatureChart.data.datasets[0].data.push(entry.temperature.toFixed(2));
          }

          // Acceleration
          if (entry.acceleration !== null) {
            accelChart.data.labels.push(timeSec);
            accelChart.data.datasets[0].data.push(entry.acceleration.toFixed(2));
          }

          // Descent Rate
          if (entry.descent_rate !== null) {
            descentChart.data.labels.push(timeSec);
            descentChart.data.datasets[0].data.push(entry.descent_rate.toFixed(2));
          }

          // GPS
          if (entry.latitude !== null && entry.longitude !== null) {
            // color from older points (blue) to newer points (red)
            let fraction = i / telemetry.length;
            let color = `rgba(${Math.round(255*fraction)}, 0, ${Math.round(255*(1-fraction))}, 1)`;
            gpsChart.data.datasets[0].data.push({ x: +entry.longitude, y: +entry.latitude });
            gpsChart.data.datasets[0].pointBackgroundColor.push(color);
          }
        }

        // Update the charts without animation to avoid flicker
        altitudeChart.update('none');
        temperatureChart.update('none');
        accelChart.update('none');
        descentChart.update('none');
        gpsChart.update('none');

      } catch (err) {
        console.error("Error fetching data:", err);
      }
    }

    // Poll every second
    setInterval(fetchDataAndUpdateCharts, 1000);
    fetchDataAndUpdateCharts();
  </script>
</body>
</html>
