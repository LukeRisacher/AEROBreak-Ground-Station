<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Rocket Telemetry Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f4f4f4;
      text-align: center;
    }
    .dashboard-container {
      display: flex;
      justify-content: space-between;
      width: 97vw;
      height: 95vh;
      padding: 3vh;
      padding-top: 1vh;
      padding-bottom: 0vh;
      gap: 0;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 31vw);
      grid-template-rows: repeat(2, 42vh);
      gap: 1vw;
      width: 60vw;
      height: 90vh;
    }
    .chart-container {
      width: 100%;
      height: 100%;
      background: white;
      border-radius: 8px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    }
    .gps-container {
      width: 33vw;
      height: 86vh;
      background: white;
      border-radius: 8px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gps-container canvas {
      width: 100% !important;
      height: 100% !important;
      aspect-ratio: 1 / 1;
    }
  </style>
</head>
<body>
  <h1>Rocket Telemetry Dashboard</h1>
  <div class="dashboard-container">
    <div class="charts-grid">
      <div class="chart-container">
        <canvas id="altitudeChart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="velocityChart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="accelChart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="temperatureChart"></canvas>
      </div>
    </div>
    <div class="gps-container">
      <canvas id="gpsChart"></canvas>
    </div>
  </div>

  <script>
    const createChart = (id, label, borderColor, yTitle) => {
      return new Chart(document.getElementById(id), {
        type: 'line',
        data: { datasets: [{ label, data: [], borderColor, fill: false }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { type: 'linear', title: { display: true, text: 'Time (s)' }, min: 0 },
            y: { title: { display: true, text: yTitle } }
          }
        }
      });
    };

    const altitudeChart = createChart('altitudeChart', 'Altitude (ft)', 'blue', 'Altitude (ft)');
    const temperatureChart = createChart('temperatureChart', 'Temperature (°F)', 'red', 'Temperature (°F)');
    const accelChart = createChart('accelChart', 'Acceleration (ft/s²)', 'green', 'Acceleration (ft/s²)');
    const velocityChart = createChart('velocityChart', 'Velocity (ft/s)', 'orange', 'Velocity (ft/s)');

    const gpsChart = new Chart(document.getElementById('gpsChart'), {
      type: 'scatter',
      data: { datasets: [{ label: 'GPS Path', data: [], showLine: true, borderColor: 'gray', pointRadius: 4 }] },
      options: { 
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: { title: { display: true, text: 'Longitude' } }, y: { title: { display: true, text: 'Latitude' } } }
      }
    });

    function processSamples(samples) {
      if (!Array.isArray(samples) || samples.length === 0) return;
      samples.sort((a, b) => a.timestamp - b.timestamp);
      const t0 = samples[0].timestamp;
      const updateChartData = (chart, key) => {
        chart.data.datasets[0].data = samples.filter(s => s[key] !== null).map(s => ({ x: s.timestamp - t0, y: s[key] }));
        chart.update('none');
      };
      updateChartData(altitudeChart, 'altitude');
      updateChartData(temperatureChart, 'temperature');
      updateChartData(accelChart, 'acceleration');
      updateChartData(velocityChart, 'velocity');
    }

    function processGps(gps) {
      if (!Array.isArray(gps) || gps.length === 0) return;
      gps.sort((a, b) => a.timestamp - b.timestamp);
      gpsChart.data.datasets[0].data = gps.map(g => ({ x: g.longitude, y: g.latitude }));
      gpsChart.update('none');
    }

    async function updateCharts() {
      try {
        const resp = await fetch('/data');
        const data = await resp.json();
        processSamples(data.samples);
        processGps(data.gps);
      } catch (err) {
        console.error("Error fetching data:", err);
      }
    }

    setInterval(updateCharts, 1000);
    updateCharts();
  </script>
</body>
</html>
